<h1>Turbopack 간접 의존성 경고와 해결법</h1>
<h2 data-ke-size="size26">문제 상황 타임라인</h2>
<h3 data-ke-size="size23">1️⃣ 초기 상황</h3>
<p data-ke-size="size16"><b>프로젝트 환경:</b></p>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li>Next.js 15.5.4 + Turbopack</li>
<li>Sentry + OpenTelemetry 설정 완료</li>
<li>개발 서버 실행 중</li>
</ul>
<h3 data-ke-size="size23">2️⃣ 경고 발생</h3>
<pre class="gauss"><code>⚠ ./node_modules/.pnpm/@opentelemetry+instrumentation@0.204.0_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/instrumentation/build/esm/platform/node
Package require-in-the-middle can't be external
The request require-in-the-middle matches serverExternalPackages (or the default list).
The request could not be resolved by Node.js from the project directory.
Packages that should be external need to be installed in the project directory, so they can be resolved from the output files.
Try to install it into the project directory by running npm install require-in-the-middle from the project directory.</code></pre>
<h3 data-ke-size="size23">3️⃣ 문제 파악</h3>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li><code>import-in-the-middle</code>, <code>require-in-the-middle</code> 패키지가 문제</li>
<li>직접 설치한 패키지가 아닌 <b>간접 의존성</b></li>
<li>Sentry와 OpenTelemetry가 내부적으로 사용</li>
</ul>
<h2 data-ke-size="size26">문제 발생 원인</h2>
<h3 data-ke-size="size23">의존성 구조 분석</h3>
<pre class="moonscript"><code>your-project/
├── package.json (직접 의존성)
│   ├── @sentry/nextjs
│   └── @opentelemetry/instrumentation
│
└── node_modules/ (설치된 패키지들)
    ├── @sentry/
    │   └── (내부 어딘가)/
    │       └── node_modules/
    │           └── import-in-the-middle/  &larr; 간접 의존성!
    │
    └── @opentelemetry/
        └── (내부 어딘가)/
            └── node_modules/
                └── require-in-the-middle/  &larr; 간접 의존성!</code></pre>
<h3 data-ke-size="size23">Turbopack의 동작 원리</h3>
<ol style="list-style-type: decimal;" data-ke-list-type="decimal">
<li><b>번들링 시도</b>: Turbopack이 코드를 번들링하려 함</li>
<li><b>External 판단</b>: 특정 패키지를 "external"로 처리하기로 결정</li>
<li><b>경로 확인</b>: 프로젝트 루트 (<code>/your-project/node_modules/</code>)에서 패키지 찾기 시도</li>
<li><b>실패</b>: 간접 의존성이라 루트에 없음 &rarr; ⚠️ 경고!</li>
</ol>
<h3 data-ke-size="size23">왜 이 패키지들이 문제인가?</h3>
<pre class="livecodeserver"><code>// import-in-the-middle과 require-in-the-middle의 역할
// Node.js의 모듈 로딩 시스템을 가로채서(hook) 
// 런타임에 코드를 주입하는 특수한 패키지들
<p>// Sentry/OpenTelemetry가 이걸 사용하는 이유:
// → 자동으로 에러 추적, 성능 모니터링 코드를 주입하기 위해</code></pre></p>
<h2 data-ke-size="size26">해결 방법</h2>
<h3 data-ke-size="size23">next.config.ts 수정</h3>
<pre class="cpp"><code>// next.config.ts
const nextConfig: NextConfig = {
  // OpenTelemetry instrumentation이 사용하는 패키지들을 external로 처리
  // 이 패키지들은 Sentry와 OpenTelemetry의 의존성으로 사용되며,
  // Node.js 런타임에서 모듈을 동적으로 instrument하기 위해 필요합니다.
  serverExternalPackages: [
    "import-in-the-middle",
    "require-in-the-middle",
  ],
};
<p>export default nextConfig;</code></pre></p>
<h2 data-ke-size="size26">해결 원리 이해하기</h2>
<h3 data-ke-size="size23">serverExternalPackages가 하는 일</h3>
<pre class="maxima"><code>// Before: Turbopack의 기본 동작
{
  번들링_시도: true,
  프로젝트_루트에서_찾기: true,  // 실패! &rarr; 경고
  런타임_동작: "Node.js가 알아서 찾음"  // 정상 작동
}
<p>// After: serverExternalPackages 설정 후
{
번들링_시도: false,  // 아예 시도 안 함!
프로젝트_루트에서_찾기: false,  // 확인할 필요 없음
런타임_동작: &quot;Node.js가 알아서 찾음&quot;  // 정상 작동
}</code></pre></p>
<h3 data-ke-size="size23">Node.js 모듈 해석 알고리즘</h3>
<pre class="json"><code>// require('import-in-the-middle') 호출 시 Node.js의 탐색 순서:
[
  '/your-project/node_modules/import-in-the-middle',  // ❌ 없음
  '/your-project/node_modules/@sentry/.../node_modules/import-in-the-middle',  // ✅ 찾음!
  // 상위 디렉토리로 계속 올라가며 탐색...
]</code></pre>
<h2 data-ke-size="size26">핵심 개념 정리</h2>
<h3 data-ke-size="size23">External Package란?</h3>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li><b>번들에 포함 안 함</b>: 빌드 결과물에 패키지 코드를 넣지 않음</li>
<li><b>런타임 로드</b>: 실행 시점에 <code>require()</code>로 동적 로드</li>
<li><b>용도</b>: Native 모듈, Node.js 특화 기능, 큰 바이너리 파일 등</li>
</ul>
<h3 data-ke-size="size23">간접 의존성 (Transitive Dependencies)</h3>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li><b>정의</b>: 내가 설치한 패키지가 의존하는 다른 패키지</li>
<li><b>위치</b>: 중첩된 node_modules 폴더에 존재</li>
<li><b>문제점</b>: 번들러가 찾기 어려울 수 있음</li>
</ul>
<h2 data-ke-size="size26">기억해 둘 것!</h2>
<h3 data-ke-size="size23">경고 신호 인식하기</h3>
<p data-ke-size="size16">다음 패턴을 보면 즉시 간접 의존성 문제 의심:</p>
<pre class="crmsh"><code>⚠ Package [패키지명] can't be external
The request could not be resolved by Node.js from the project directory.</code></pre>
<h3 data-ke-size="size23">문제 패키지 유형</h3>
<p data-ke-size="size16"><b>1. Instrumentation/Monitoring 도구</b></p>
<pre class="dts"><code>serverExternalPackages: [
  // APM, 모니터링
  "import-in-the-middle",
  "require-in-the-middle", 
  "dd-trace",
  "elastic-apm-node",
  "@newrelic/native-metrics"
]</code></pre>
<p data-ke-size="size16"><b>2. Native 바인딩 패키지</b></p>
<pre class="dts"><code>serverExternalPackages: [
  // 이미지, 암호화, 캔버스
  "sharp",
  "bcrypt", 
  "canvas",
  "node-gyp"
]</code></pre>
<p data-ke-size="size16"><b>3. Database 드라이버</b></p>
<pre class="dts"><code>serverExternalPackages: [
  // DB 관련
  "@prisma/engines",
  "pg-native",
  "oracledb"
]</code></pre>
<h3 data-ke-size="size23">  디버깅 명령어</h3>
<pre class="routeros"><code># 1. 패키지가 어디서 오는지 확인 (pnpm)
pnpm why [패키지명]
<h1>2. 의존성 트리 확인</h1>
<p>pnpm list --depth=3 | grep [패키지명]</p>
<h1>3. node_modules 구조 직접 확인</h1>
<p>find node_modules -name &quot;[패키지명]&quot; -type d</code></pre></p>
<h3 data-ke-size="size23">✅ 프로-액티브하게 해결하기</h3>
<pre class="javascript"><code>// next.config.ts - 종합 템플릿
import { NextConfig } from 'next';
<p>// 프로젝트 시작 시 미리 설정해두면 좋은 패키지들
const commonExternalPackages = [
// === Instrumentation ===
&quot;import-in-the-middle&quot;,
&quot;require-in-the-middle&quot;,</p>
<p>// === Native Modules ===
&quot;sharp&quot;,
&quot;canvas&quot;,
&quot;bcrypt&quot;,</p>
<p>// === Database ===
&quot;@prisma/engines&quot;,
&quot;pg-native&quot;,</p>
<p>// === Monitoring ===
&quot;dd-trace&quot;,
&quot;pino-pretty&quot;,</p>
<p>// === 프로젝트별 추가 ===
// ...여기에 프로젝트 특수 패키지 추가
];</p>
<p>const nextConfig: NextConfig = {
serverExternalPackages: process.env.NODE_ENV === 'development'
? commonExternalPackages
: commonExternalPackages.filter(pkg =&gt;
// 프로덕션에서는 필요한 것만
!pkg.includes('pretty')
),
};</p>
<p>export default nextConfig;</code></pre></p>
<h2 data-ke-size="size26">핵심 교훈</h2>
<blockquote data-ke-style="style1">
<p data-ke-size="size16"><b>"Turbopack은 Webpack보다 엄격하다"</b></p>
<p data-ke-size="size16">Webpack: 암묵적으로 많은 것을 처리</p>
<p data-ke-size="size16">Turbopack: 명시적 선언 필요</p>
</blockquote>
<blockquote data-ke-style="style1">
<p data-ke-size="size16"><b>"간접 의존성은 숨어있다"</b></p>
<p data-ke-size="size16">직접 설치하지 않은 패키지도 문제를 일으킬 수 있음</p>
<p data-ke-size="size16">특히 Native 모듈, Instrumentation 도구 주의</p>
</blockquote>
<blockquote data-ke-style="style1">
<p data-ke-size="size16"><b>"경고는 무시하지 말자"</b></p>
<p data-ke-size="size16">당장은 작동해도 프로덕션 빌드에서 문제될 수 있음</p>
<p data-ke-size="size16">개발 환경을 깨끗하게 유지하는 것이 중요</p>
</blockquote>
<h2 data-ke-size="size26">  참고 자료</h2>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li><a href="https://nextjs.org/docs/app/api-reference/next-config-js/serverExternalPackages">Next.js serverExternalPackages 문서</a></li>
<li><a href="https://turbo.build/pack/docs">Turbopack 공식 문서</a></li>
<li><a href="https://nodejs.org/api/modules.html#modules_all_together">Node.js 모듈 해석 알고리즘</a></li>
</ul>
<hr data-ke-style="style1" />
<p data-ke-size="size16">  <b>Quick Fix 요약</b></p>
<pre class="awk"><code>// 문제 발생 시 즉시 적용:
// 1. 경고 메시지에서 패키지명 확인
// 2. next.config.ts에 추가
serverExternalPackages: ["문제의-패키지-이름"]
// 3. 개발 서버 재시작</code></pre>