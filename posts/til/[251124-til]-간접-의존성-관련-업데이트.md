<h1> pnpm 문제 였나?</h1>
<h2 data-ke-size="size26">해결 방법</h2>
<h3 data-ke-size="size23">⚠️ Next.js 버전별 차이점</h3>
<h4 data-ke-size="size20">Next.js 15.5+ 변경사항</h4>
<pre class="actionscript"><code>// Next.js 15.5부터는 require-in-the-middle이 기본적으로 opt-out됨!
// 하지만 import-in-the-middle은 여전히 명시 필요
const nextConfig: NextConfig = {
  serverExternalPackages: [
    "import-in-the-middle",  // 여전히 필요
    // "require-in-the-middle",  // 15.5+에서는 불필요 (기본 opt-out)
  ],
};</code></pre>
<h3 data-ke-size="size23">방법 1: next.config.ts 수정 (기본)</h3>
<pre class="dart"><code>// next.config.ts
const nextConfig: NextConfig = {
  serverExternalPackages: [
    "import-in-the-middle",
    // Next.js &lt; 15.5인 경우에만 추가
    ...(process.env.NEXT_VERSION &lt; '15.5' ? ["require-in-the-middle"] : []),
  ],
};
<p>export default nextConfig;</code></pre></p>
<h3 data-ke-size="size23">방법 2: pnpm 사용 시 - .npmrc 설정 (권장)</h3>
<p data-ke-size="size16">pnpm의 엄격한 의존성 격리 때문에 발생하는 문제는 <code>.npmrc</code> 설정으로 해결:</p>
<pre class="ini"><code># .npmrc
# pnpm의 엄격한 의존성 격리를 완화
# Sentry와 같은 instrumentation 도구가 간접 의존성에 접근할 수 있도록 허용
node-linker=hoisted
<h1>또는 부분적으로만 hoisting (더 안전)</h1>
<p>public-hoist-pattern[]=<em>import-in-the-middle</em>
public-hoist-pattern[]=<em>require-in-the-middle</em></code></pre></p>
<h4 data-ke-size="size20">pnpm의 의존성 격리 이해하기</h4>
<pre class="elixir"><code># 기본 pnpm 구조 (격리됨)
node_modules/
├── .pnpm/
│   ├── @sentry+nextjs@8.0.0/
│   │   └── node_modules/
│   │       ├── @sentry/nextjs/  &larr; 실제 코드
│   │       └── import-in-the-middle/  &larr; 격리된 의존성
│   └── import-in-the-middle@1.0.0/
│       └── node_modules/
│           └── import-in-the-middle/
└── @sentry/  &larr; 심볼릭 링크
    └── nextjs/
<h1>hoisted 구조 (npm/yarn과 유사)</h1>
<p>node_modules/
├── @sentry/
│   └── nextjs/
└── import-in-the-middle/  ← 최상위로 끌어올림</code></pre></p>
<h3 data-ke-size="size23">방법 3: 종합 해결책 (pnpm + Next.js 15.5+)</h3>
<pre class="ini"><code># .npmrc (프로젝트 루트)
# Sentry 관련 패키지만 선택적으로 hoisting
public-hoist-pattern[]=*import-in-the-middle*
public-hoist-pattern[]=*require-in-the-middle*
shamefully-hoist=false  # 전체 hoisting은 하지 않음</code></pre>
<pre class="actionscript"><code>// next.config.ts
const nextConfig: NextConfig = {
  serverExternalPackages: [
    "import-in-the-middle",  // Next.js 15.5+에서도 필요
  ],
};</code></pre>
<h2 data-ke-size="size26">  해결 원리 이해하기</h2>
<h3 data-ke-size="size23">serverExternalPackages가 하는 일</h3>
<pre class="maxima"><code>// Before: Turbopack의 기본 동작
{
  번들링_시도: true,
  프로젝트_루트에서_찾기: true,  // 실패! &rarr; 경고
  런타임_동작: "Node.js가 알아서 찾음"  // 정상 작동
}
<p>// After: serverExternalPackages 설정 후
{
번들링_시도: false,  // 아예 시도 안 함!
프로젝트_루트에서_찾기: false,  // 확인할 필요 없음
런타임_동작: &quot;Node.js가 알아서 찾음&quot;  // 정상 작동
}</code></pre></p>
<h3 data-ke-size="size23">pnpm vs npm/yarn 차이점</h3>
<h4 data-ke-size="size20">npm/yarn의 flat 구조</h4>
<pre class="livecodeserver"><code>node_modules/
├── @sentry/nextjs/
├── import-in-the-middle/  &larr; 모든 패키지가 접근 가능
└── require-in-the-middle/</code></pre>
<h4 data-ke-size="size20">pnpm의 격리된 구조</h4>
<pre class="coffeescript"><code>node_modules/
├── .pnpm/  &larr; 실제 패키지들 (격리됨)
│   └── @sentry+nextjs@8.0.0/
│       └── node_modules/
│           ├── @sentry/nextjs/
│           └── import-in-the-middle/  &larr; Sentry만 접근 가능
└── @sentry/  &larr; 심볼릭 링크
    └── nextjs/</code></pre>
<p data-ke-size="size16"><b>pnpm의 장점</b>:</p>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li>디스크 공간 절약</li>
<li>의존성 충돌 방지</li>
<li>더 엄격한 의존성 관리</li>
</ul>
<p data-ke-size="size16"><b>pnpm의 단점</b>:</p>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li>Instrumentation 도구들이 간접 의존성 접근 어려움</li>
<li>Turbopack과 충돌 가능성</li>
</ul>
<h3 data-ke-size="size23">Node.js 모듈 해석 알고리즘</h3>
<pre class="swift"><code>// require('import-in-the-middle') 호출 시 Node.js의 탐색 순서:
[
  '/your-project/node_modules/import-in-the-middle',  // ❌ pnpm에서는 없음
  '/your-project/node_modules/@sentry/.../node_modules/import-in-the-middle',  // ❌ 심볼릭 링크
  '/your-project/node_modules/.pnpm/.../import-in-the-middle',  // ✅ 실제 위치
]</code></pre>
<h2 data-ke-size="size26">  참고 자료 업데이트</h2>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li><a href="https://nextjs.org/docs/app/api-reference/next-config-js/serverExternalPackages">Next.js serverExternalPackages 문서</a> - 15.5부터 require-in-the-middle 기본 opt-out</li>
<li><a href="https://docs.sentry.io/platforms/javascript/guides/nextjs/troubleshooting/#pnpm-resolving-import-in-the-middle-external-package-errors">Sentry pnpm 트러블슈팅</a></li>
<li><a href="https://pnpm.io/motivation#creating-a-non-flat-node_modules-directory">pnpm의 node_modules 구조</a></li>
<li><a href="https://turbo.build/pack/docs">Turbopack 공식 문서</a></li>
<li><a href="https://nodejs.org/api/modules.html#modules_all_together">Node.js 모듈 해석 알고리즘</a></li>
</ul>
<hr data-ke-style="style1" />
<p data-ke-size="size16">  *<i>Quick Fix *</i></p>
<h3 data-ke-size="size23">npm/yarn 사용자</h3>
<pre class="vim"><code>// next.config.ts에 추가
serverExternalPackages: ["문제의-패키지-이름"]</code></pre>
<h3 data-ke-size="size23">pnpm 사용자 (Sentry 등 instrumentation 도구)</h3>
<pre class="jboss-cli"><code># 1. .npmrc 파일 생성/수정
echo "public-hoist-pattern[]=*import-in-the-middle*" &gt;&gt; .npmrc
echo "public-hoist-pattern[]=*require-in-the-middle*" &gt;&gt; .npmrc
<h1>2. 의존성 재설치</h1>
<p>rm -rf node_modules pnpm-lock.yaml
pnpm install</p>
<h1>3. Next.js 15.5+ 사용 시</h1>
<h1>next.config.ts에 import-in-the-middle만 추가 (require는 기본 opt-out)</code></pre></h1>
<h3 data-ke-size="size23">버전별 체크</h3>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li><b>Next.js &lt; 15.5</b>: 두 패키지 모두 serverExternalPackages에 추가</li>
<li><b>Next.js &ge; 15.5</b>: import-in-the-middle만 추가 (require-in-the-middle은 기본 제외됨)</li>
<li><b>pnpm 사용 시</b>: 추가로 .npmrc 설정 필요</li>
</ul>